<view class="main">
  <view class="top-bar bar">
    <view class="title">ä½“æ£€æŠ¥å‘Šè¯¦æƒ…</view>
  </view>

  <view wx:if="{{!isLoad}}" class="loading">
    <view class="loading-icon"></view>
    <view class="loading-text">æ­£åœ¨åŠ è½½æŠ¥å‘Šæ•°æ®...</view>
  </view>

  <block wx:elif="{{isLoad && report}}">
    <view class="report-header">
      <view class="hospital">{{report.hospital || 'æœªçŸ¥åŒ»é™¢'}}</view>
      <view class="date">ä½“æ£€æ—¥æœŸï¼š{{report.reportDate || 'æœªçŸ¥æ—¥æœŸ'}}</view>
    </view>
    
    <view class="report-content">
      <view class="section">
        <view class="section-title">
          <view class="title-text">
            <text class="title-icon">ğŸ“‹</text>
            <text>åŸºæœ¬ä¿¡æ¯</text>
          </view>
        </view>
        <view class="info-row">
          <text class="label">æŠ¥å‘Šç±»å‹</text>
          <text class="value">{{report.reportType || 'å¸¸è§„ä½“æ£€'}}</text>
        </view>
        <view class="info-row">
          <text class="label">ä½“æ£€æ—¥æœŸ</text>
          <text class="value">{{report.reportDate || 'æœªçŸ¥æ—¥æœŸ'}}</text>
        </view>
        <view class="info-row">
          <text class="label">åŒ»é™¢</text>
          <text class="value">{{report.hospital || 'æœªçŸ¥åŒ»é™¢'}}</text>
        </view>
      </view>
      
      <view class="section">
        <view class="section-title">
          <view class="title-text">
            <text class="title-icon">ğŸ“</text>
            <text>æŠ¥å‘Šæ‘˜è¦</text>
          </view>
        </view>
        <view class="summary">{{report.summary || 'æ­¤æŠ¥å‘Šæš‚æ— æ‘˜è¦ä¿¡æ¯'}}</view>
      </view>
      
      <!-- AIåˆ†æç»“æœ -->
      <view class="section ai-section {{showAiResult ? 'expanded' : ''}}" wx:if="{{report.aiAnalysis || report.aiAnalysisText}}">
        <view class="section-title" bindtap="toggleAiResult">
          <view class="title-text">
            <text class="title-icon">ğŸ¤–</text>
            <text>AIæ™ºèƒ½åˆ†æ</text>
          </view>
          <text class="toggle-icon">{{showAiResult ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        <view class="ai-content {{showAiResult ? 'show' : ''}}">
          <view class="ai-header" wx:if="{{report.aiAnalysisTime}}">
            <view class="ai-time">
              åˆ†ææ—¶é—´ï¼š{{formatDate(report.aiAnalysisTime)}}
            </view>
          </view>
          
          <view class="risk-level">
            <view class="risk-label">å¥åº·é£é™©è¯„çº§ï¼š</view>
            <view class="risk-value {{report.aiRiskLevel == 'high' ? 'high' : (report.aiRiskLevel == 'medium' ? 'medium' : 'low')}}">
              {{report.aiRiskLevel == 'high' ? 'é«˜' : (report.aiRiskLevel == 'medium' ? 'ä¸­' : 'ä½')}}
            </view>
          </view>
          
          <view class="ai-markdown">
            <text user-select decode>{{report.aiAnalysisText || report.aiAnalysis}}</text>
          </view>
        </view>
      </view>
      
      <!-- æŠ¥å‘Šé¡¹ç›® -->
      <view class="section" wx:if="{{report.reportItems && report.reportItems.length > 0}}">
        <view class="section-title">
          <view class="title-text">
            <text class="title-icon">ğŸ”¬</text>
            <text>æ£€æŸ¥é¡¹ç›®</text>
          </view>
        </view>
        <view class="report-items">
          <block wx:for="{{report.reportItems}}" wx:key="name" wx:for-item="group">
            <view class="item-group">
              <view class="group-name">{{group.name}}</view>
              <view class="item-list">
                <view class="item" wx:for="{{group.items}}" wx:key="name">
                  <view class="item-name">{{item.name}}</view>
                  <view class="item-value {{item.abnormal ? 'abnormal' : ''}}">
                    {{item.value}} {{item.unit}}
                    <text wx:if="{{item.abnormal}}" class="abnormal-mark">*</text>
                  </view>
                  <view class="item-range">
                    <text class="range-text">å‚è€ƒèŒƒå›´: {{item.referenceRange}}</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
    
    <view class="report-footer">
      <button class="btn-primary" bindtap="bindViewFileTap">æŸ¥çœ‹åŸå§‹æŠ¥å‘Š</button>
      <button class="btn-default {{isAnalyzing ? 'analyzing' : ''}}" bindtap="bindAnalyzeByAI" disabled="{{isAnalyzing}}">
        <view class="btn-content">
          <view class="analyzing-animation" wx:if="{{isAnalyzing}}">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
          <text>{{isAnalyzing ? 'åˆ†æä¸­...' : (report.aiAnalysis ? 'é‡æ–°åˆ†æ' : 'AI æ™ºèƒ½åˆ†æ')}}</text>
        </view>
      </button>
    </view>
  </block>

  <view wx:elif="{{isLoad && !report}}" class="no-data">
    <image class="icon-empty" src="/projects/A00/skin/images/icon/empty.png"></image>
    <view class="hint">æŠ¥å‘Šä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</view>
  </view>
</view> 