<view class="main">
  <view class="top-bar bar">
    <view class="title">体检报告详情</view>
  </view>

  <view wx:if="{{!isLoad}}" class="loading">
    <view class="loading-icon"></view>
    <view class="loading-text">加载中...</view>
  </view>

  <block wx:elif="{{isLoad && report}}">
    <view class="report-header">
      <view class="hospital">{{report.hospital}}</view>
      <view class="date">{{report.reportDate}}</view>
    </view>
    
    <view class="report-content">
      <view class="section">
        <view class="section-title">基本信息</view>
        <view class="info-row">
          <text class="label">报告类型</text>
          <text class="value">{{report.reportType}}</text>
        </view>
        <view class="info-row">
          <text class="label">体检日期</text>
          <text class="value">{{report.reportDate}}</text>
        </view>
        <view class="info-row">
          <text class="label">医院</text>
          <text class="value">{{report.hospital}}</text>
        </view>
      </view>
      
      <view class="section">
        <view class="section-title">报告摘要</view>
        <view class="summary">{{report.summary || '无摘要信息'}}</view>
      </view>
      
      <!-- AI分析结果 -->
      <view class="section ai-section {{showAiResult ? 'expanded' : ''}}" wx:if="{{report.aiAnalysis}}">
        <view class="section-title" bindtap="toggleAiResult">
          <view class="title-text">
            <text class="title-icon">🤖</text>
            <text>AI智能分析</text>
          </view>
          <text class="toggle-icon">{{showAiResult ? '收起' : '展开'}}</text>
        </view>
        <view class="ai-content {{showAiResult ? 'show' : ''}}">
          <view class="ai-header">
            <view class="ai-risk">
              <text class="risk-label">健康风险：</text>
              <text class="risk-value {{report.aiAnalysis.riskLevel === '低' ? 'low' : (report.aiAnalysis.riskLevel === '中' ? 'medium' : 'high')}}">
                {{report.aiAnalysis.riskLevel || '未知'}}
              </text>
            </view>
            <view class="ai-time" wx:if="{{report.aiAnalysisTime}}">
              分析时间：{{formatDate(report.aiAnalysisTime)}}
            </view>
          </view>
          
          <view class="ai-suggestion">
            <view class="suggestion-title">健康建议</view>
            <view class="suggestion-content">{{report.aiAnalysis.suggestion || '暂无健康建议'}}</view>
          </view>
          
          <view class="ai-details">
            <view class="details-title">详细分析</view>
            <view class="details-content">{{report.aiAnalysis.details || '暂无详细分析'}}</view>
          </view>
        </view>
      </view>
      
      <!-- 报告项目 -->
      <view class="section" wx:if="{{report.reportItems && report.reportItems.length > 0}}">
        <view class="section-title">检查项目</view>
        <view class="report-items">
          <block wx:for="{{report.reportItems}}" wx:key="name" wx:for-item="group">
            <view class="item-group">
              <view class="group-name">{{group.name}}</view>
              <view class="item-list">
                <view class="item" wx:for="{{group.items}}" wx:key="name">
                  <view class="item-name">{{item.name}}</view>
                  <view class="item-value {{item.abnormal ? 'abnormal' : ''}}">
                    {{item.value}} {{item.unit}}
                    <text wx:if="{{item.abnormal}}" class="abnormal-mark">*</text>
                  </view>
                  <view class="item-range">
                    <text class="range-text">参考范围: {{item.referenceRange}}</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
    
    <view class="report-footer">
      <button class="btn-primary" bindtap="bindViewFileTap">查看原始报告</button>
      <button class="btn-default {{isAnalyzing ? 'analyzing' : ''}}" bindtap="bindAnalyzeByAI" disabled="{{isAnalyzing}}">
        <view class="btn-content">
          <view class="analyzing-animation" wx:if="{{isAnalyzing}}">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
          <text>{{isAnalyzing ? '分析中...' : (report.aiAnalysis ? '重新分析' : 'AI 智能分析')}}</text>
        </view>
      </button>
    </view>
  </block>

  <view wx:elif="{{isLoad && !report}}" class="no-data">
    <image class="icon-empty" src="/images/icon/empty.png"></image>
    <view class="hint">报告不存在或已被删除</view>
  </view>

  <!-- AI分析结果弹窗 -->
  <view class="modal" wx:if="{{showAiResult && report.aiAnalysis}}">
    <view class="modal-mask" bindtap="bindCloseAiResult"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">AI 健康分析报告</view>
        <view class="modal-close" bindtap="bindCloseAiResult">×</view>
      </view>
      <view class="modal-body">
        <view class="ai-result-section">
          <view class="ai-result-title">健康建议</view>
          <view class="ai-result-content">{{report.aiAnalysis.suggestion}}</view>
        </view>
        <view class="ai-result-section">
          <view class="ai-result-title">健康风险</view>
          <view class="ai-result-content">
            <text class="ai-risk-level {{report.aiAnalysis.riskLevel === '高' ? 'high' : (report.aiAnalysis.riskLevel === '中' ? 'medium' : 'low')}}">{{report.aiAnalysis.riskLevel}}</text>
          </view>
        </view>
        <view class="ai-result-section">
          <view class="ai-result-title">详细分析</view>
          <view class="ai-result-content ai-details">{{report.aiAnalysis.details}}</view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn-close" bindtap="bindCloseAiResult">关闭</button>
      </view>
    </view>
  </view>
</view> 