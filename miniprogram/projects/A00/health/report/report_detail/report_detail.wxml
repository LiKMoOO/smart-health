<view class="main">
  <view class="top-bar bar">
    <view class="title">ä½“æ£€æŠ¥å‘Šè¯¦æƒ…</view>
  </view>

  <view wx:if="{{!isLoad}}" class="loading">
    <view class="loading-icon"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <block wx:elif="{{isLoad && report}}">
    <view class="report-header">
      <view class="hospital">{{report.hospital}}</view>
      <view class="date">{{report.reportDate}}</view>
    </view>
    
    <view class="report-content">
      <view class="section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="info-row">
          <text class="label">æŠ¥å‘Šç±»å‹</text>
          <text class="value">{{report.reportType}}</text>
        </view>
        <view class="info-row">
          <text class="label">ä½“æ£€æ—¥æœŸ</text>
          <text class="value">{{report.reportDate}}</text>
        </view>
        <view class="info-row">
          <text class="label">åŒ»é™¢</text>
          <text class="value">{{report.hospital}}</text>
        </view>
      </view>
      
      <view class="section">
        <view class="section-title">æŠ¥å‘Šæ‘˜è¦</view>
        <view class="summary">{{report.summary || 'æ— æ‘˜è¦ä¿¡æ¯'}}</view>
      </view>
      
      <!-- AIåˆ†æç»“æœ -->
      <view class="section ai-section {{showAiResult ? 'expanded' : ''}}" wx:if="{{report.aiAnalysis}}">
        <view class="section-title" bindtap="toggleAiResult">
          <view class="title-text">
            <text class="title-icon">ğŸ¤–</text>
            <text>AIæ™ºèƒ½åˆ†æ</text>
          </view>
          <text class="toggle-icon">{{showAiResult ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        <view class="ai-content {{showAiResult ? 'show' : ''}}">
          <view class="ai-header">
            <view class="ai-risk">
              <text class="risk-label">å¥åº·é£é™©ï¼š</text>
              <text class="risk-value {{report.aiAnalysis.riskLevel === 'ä½' ? 'low' : (report.aiAnalysis.riskLevel === 'ä¸­' ? 'medium' : 'high')}}">
                {{report.aiAnalysis.riskLevel || 'æœªçŸ¥'}}
              </text>
            </view>
            <view class="ai-time" wx:if="{{report.aiAnalysisTime}}">
              åˆ†ææ—¶é—´ï¼š{{formatDate(report.aiAnalysisTime)}}
            </view>
          </view>
          
          <view class="ai-suggestion">
            <view class="suggestion-title">å¥åº·å»ºè®®</view>
            <view class="suggestion-content">{{report.aiAnalysis.suggestion || 'æš‚æ— å¥åº·å»ºè®®'}}</view>
          </view>
          
          <view class="ai-details">
            <view class="details-title">è¯¦ç»†åˆ†æ</view>
            <view class="details-content">{{report.aiAnalysis.details || 'æš‚æ— è¯¦ç»†åˆ†æ'}}</view>
          </view>
        </view>
      </view>
      
      <!-- æŠ¥å‘Šé¡¹ç›® -->
      <view class="section" wx:if="{{report.reportItems && report.reportItems.length > 0}}">
        <view class="section-title">æ£€æŸ¥é¡¹ç›®</view>
        <view class="report-items">
          <block wx:for="{{report.reportItems}}" wx:key="name" wx:for-item="group">
            <view class="item-group">
              <view class="group-name">{{group.name}}</view>
              <view class="item-list">
                <view class="item" wx:for="{{group.items}}" wx:key="name">
                  <view class="item-name">{{item.name}}</view>
                  <view class="item-value {{item.abnormal ? 'abnormal' : ''}}">
                    {{item.value}} {{item.unit}}
                    <text wx:if="{{item.abnormal}}" class="abnormal-mark">*</text>
                  </view>
                  <view class="item-range">
                    <text class="range-text">å‚è€ƒèŒƒå›´: {{item.referenceRange}}</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
    
    <view class="report-footer">
      <button class="btn-primary" bindtap="bindViewFileTap">æŸ¥çœ‹åŸå§‹æŠ¥å‘Š</button>
      <button class="btn-default {{isAnalyzing ? 'analyzing' : ''}}" bindtap="bindAnalyzeByAI" disabled="{{isAnalyzing}}">
        <view class="btn-content">
          <view class="analyzing-animation" wx:if="{{isAnalyzing}}">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
          <text>{{isAnalyzing ? 'åˆ†æä¸­...' : (report.aiAnalysis ? 'é‡æ–°åˆ†æ' : 'AI æ™ºèƒ½åˆ†æ')}}</text>
        </view>
      </button>
    </view>
  </block>

  <view wx:elif="{{isLoad && !report}}" class="no-data">
    <image class="icon-empty" src="/images/icon/empty.png"></image>
    <view class="hint">æŠ¥å‘Šä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</view>
  </view>

  <!-- AIåˆ†æç»“æœå¼¹çª— -->
  <view class="modal" wx:if="{{showAiResult && report.aiAnalysis}}">
    <view class="modal-mask" bindtap="bindCloseAiResult"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">AI å¥åº·åˆ†ææŠ¥å‘Š</view>
        <view class="modal-close" bindtap="bindCloseAiResult">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="ai-result-section">
          <view class="ai-result-title">å¥åº·å»ºè®®</view>
          <view class="ai-result-content">{{report.aiAnalysis.suggestion}}</view>
        </view>
        <view class="ai-result-section">
          <view class="ai-result-title">å¥åº·é£é™©</view>
          <view class="ai-result-content">
            <text class="ai-risk-level {{report.aiAnalysis.riskLevel === 'é«˜' ? 'high' : (report.aiAnalysis.riskLevel === 'ä¸­' ? 'medium' : 'low')}}">{{report.aiAnalysis.riskLevel}}</text>
          </view>
        </view>
        <view class="ai-result-section">
          <view class="ai-result-title">è¯¦ç»†åˆ†æ</view>
          <view class="ai-result-content ai-details">{{report.aiAnalysis.details}}</view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn-close" bindtap="bindCloseAiResult">å…³é—­</button>
      </view>
    </view>
  </view>
</view> 