<!--projects/A00/health/report/health_report.wxml-->
<view class="main">
  <!-- 顶部搜索栏 -->
  <view class="search-bar" style="position: fixed; left: 29rpx; top: 31rpx; width: 699rpx; height: 114rpx; display: block; box-sizing: border-box">
    <view class="search-box">
      <image class="icon-search" src="/images/icon/search.png"></image>
      <input type="text" placeholder="搜索体检报告" model:value="{{search}}" bindinput="bindSearchInput" confirm-type="search"></input>
    </view>
  </view>

  <!-- 报告列表 -->
  <view class="report-list">
    <block wx:if="{{!reportList || reportList.length == 0}}">
      <view class="no-data">
        <image class="icon-empty" src="/images/icon/empty.png"></image>
        <text class="hint" style="position: relative; left: -100rpx; top: -120rpx">暂无体检报告</text>
      </view>
    </block>
    <block wx:else>
      <view class="report-item" wx:for="{{reportList}}" wx:key="_id" bindtap="bindReportTap" data-id="{{item._id}}">
        <view class="report-header">
          <view class="hospital">{{item.hospital}}</view>
          <view class="date">{{item.reportDate}}</view>
        </view>
        <view class="report-content">
          <view class="type">{{item.reportType}}</view>
          <view class="summary">{{item.summary}}</view>
        </view>
        <view class="report-footer">
          <view class="status {{item.status == 1 ? 'warning' : ''}}">
            {{item.status == 1 ? '需要关注' : '正常'}}
          </view>
          <view class="view-detail">查看详情 ></view>
        </view>
      </view>
    </block>
  </view>

  <!-- 底部上传按钮 -->
  <view class="float-btn" bindtap="bindUploadTap">
    <image class="icon-add" src="/images/icon/add.png"></image>
    <text>上传体检报告</text>
  </view>
</view>

<!-- 上传报告弹窗 -->
<view class="modal" wx:if="{{showUploadModal}}">
  <view class="modal-content">
    <view class="modal-header">
      <text>上传体检报告</text>
      <view class="close-btn" bindtap="onCloseUploadModal">×</view>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">体检日期</text>
        <picker mode="date" value="{{formReport.reportDate}}" bindchange="onReportInput" data-field="reportDate">
          <view class="picker">{{formReport.reportDate || '请选择体检日期'}}</view>
        </picker>
      </view>
      <view class="form-group">
        <text class="form-label">医院/机构</text>
        <input class="form-input" value="{{formReport.hospital}}" bindinput="onReportInput" data-field="hospital" placeholder="请输入医院或体检机构名称" />
      </view>
      <view class="form-group">
        <text class="form-label">体检类型</text>
        <input class="form-input" value="{{formReport.reportType}}" bindinput="onReportInput" data-field="reportType" placeholder="如: 年度体检、入职体检等" />
      </view>
      <view class="form-group">
        <text class="form-label">报告概述</text>
        <textarea class="form-textarea" value="{{formReport.summary}}" bindinput="onReportInput" data-field="summary" placeholder="简要描述体检结果，如有异常项可在此说明" />
      </view>
      <view class="form-group">
        <text class="form-label">报告文件</text>
        <view class="file-selector" bindtap="chooseReportFile">
          <text class="file-name" wx:if="{{reportFileName}}">{{reportFileName}}</text>
          <text class="file-placeholder" wx:else>点击选择文件(PDF/图片)</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="onCloseUploadModal">取消</button>
      <button class="btn-save" bindtap="onSaveReport">保存</button>
    </view>
  </view>
</view>

<!-- 异常分析弹窗 -->
<view class="modal" wx:if="{{showAnalysisModal}}">
  <view class="modal-content">
    <view class="modal-header">
      <text>异常项目分析</text>
      <view class="close-btn" bindtap="onCloseAnalysisModal">×</view>
    </view>
    <view class="modal-body">
      <view class="abnormal-list">
        <view class="abnormal-item" wx:for="{{abnormalItems}}" wx:key="name">
          <view class="abnormal-header">
            <text class="category">{{item.category}}</text>
            <text class="name">{{item.name}}</text>
          </view>
          <view class="abnormal-value">
            <text>检测值: {{item.value}}{{item.unit}}</text>
            <text>参考范围: {{item.referenceRange}}</text>
          </view>
          <view class="abnormal-analysis">
            <text>{{item.analysis || '暂无分析建议'}}</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-ok" bindtap="onCloseAnalysisModal">确定</button>
    </view>
  </view>
</view>